<template>
  <div class="space-y-4">
    <!-- 입력 폼 -->
    <div class="p-4 border rounded bg-white space-y-4 shadow-sm">
      <div>
        <p class="text-xs text-gray-500">입력한 정보로 한국 표준 이력서 PDF를 바로 생성합니다.</p>
        <h2 class="text-xl font-semibold text-gray-900">이력서 자동 생성</h2>
      </div>

      <div class="space-y-3">
        <label class="block text-sm font-medium">사진 업로드</label>
        <div class="flex items-center gap-3">
          <div class="w-[96px] h-[120px] border border-dashed border-gray-300 flex items-center justify-center overflow-hidden bg-gray-50">
            <img v-if="photoUrl" :src="photoUrl" alt="사진 미리보기" class="object-cover w-full h-full" />
            <span v-else class="text-xs text-gray-400">4x5 비율</span>
          </div>
          <input type="file" accept="image/*" @change="onPhotoChange" class="text-sm" />
        </div>
      </div>

        <div class="grid gap-3 md:grid-cols-2">
          <div>
            <label class="block text-sm font-medium mb-1">성명</label>
            <input v-model.trim="resumeData.name" type="text" class="w-full px-3 py-2 border rounded" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">생년월일</label>
            <input v-model.trim="resumeData.birthDate" type="text" placeholder="YYYY.MM.DD" class="w-full px-3 py-2 border rounded" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">주소</label>
            <input v-model.trim="resumeData.address" type="text" class="w-full px-3 py-2 border rounded" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">연락처</label>
            <input v-model.trim="resumeData.phone" type="text" placeholder="010-0000-0000" class="w-full px-3 py-2 border rounded" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">이메일</label>
            <input v-model.trim="resumeData.email" type="email" class="w-full px-3 py-2 border rounded" />
          </div>
          <div>
            <label class="block text-sm font-medium mb-1">작성일</label>
            <input v-model.trim="resumeData.writtenDate" type="text" placeholder="YYYY.MM.DD" class="w-full px-3 py-2 border rounded" />
          </div>
        </div>

      <div class="space-y-2">
        <div class="flex items-center justify-between">
          <label class="text-sm font-medium">학력 및 경력사항</label>
          <button type="button" @click="addCareer" class="text-sm text-brand-600">+ 추가</button>
        </div>
        <div class="space-y-2">
          <div v-for="(career, idx) in resumeData.careers" :key="idx" class="p-3 border rounded bg-gray-50 space-y-2">
            <div class="grid gap-2 md:grid-cols-[110px,1fr,1fr] items-center">
              <input v-model.trim="career.date" type="text" placeholder="년월일" class="px-2 py-1 border rounded text-sm" />
              <input v-model.trim="career.content" type="text" placeholder="학력 및 경력사항" class="px-2 py-1 border rounded text-sm" />
              <div class="flex items-center gap-2">
                <input v-model.trim="career.note" type="text" placeholder="발령청(비고)" class="flex-1 px-2 py-1 border rounded text-sm" />
                <button type="button" @click="removeCareer(idx)" class="text-xs text-gray-500">삭제</button>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="grid gap-3 md:grid-cols-2">
        <div>
          <label class="block text-sm font-medium mb-1">서명</label>
          <input v-model.trim="resumeData.signature" type="text" placeholder="자필 서명 입력" class="w-full px-3 py-2 border rounded" />
        </div>
        <div class="flex items-end justify-end gap-2">
          <button type="button" @click="resetForm" class="px-3 py-2 bg-gray-100 rounded border">초기화</button>
          <button type="button" @click="generateDocx" :disabled="loadingDocx" class="px-3 py-2 bg-brand-500 text-white rounded disabled:opacity-60">
            {{ loadingDocx ? 'DOCX 생성 중...' : 'DOCX 생성/저장' }}
          </button>
          <button type="button" @click="downloadPDF" class="px-3 py-2 bg-brand-600 text-white rounded">PDF 다운로드</button>
        </div>
      </div>

      <div class="grid gap-3 md:grid-cols-3">
        <label class="flex items-center gap-2 text-sm font-medium">
          <input type="checkbox" v-model="docxOptions.saveToDocuments" class="h-4 w-4" />
          생성 시 서류함에 저장
        </label>
        <div>
          <label class="block text-xs text-gray-600 mb-1">문서 제목</label>
          <input v-model.trim="docxOptions.documentTitle" type="text" class="w-full px-3 py-2 border rounded" placeholder="예) 이력서_홍길동" />
        </div>
        <div>
          <label class="block text-xs text-gray-600 mb-1">상태</label>
          <select v-model="docxOptions.status" class="w-full px-3 py-2 border rounded bg-white">
            <option value="완료">완료</option>
            <option value="작성중">작성중</option>
            <option value="제출">제출</option>
          </select>
        </div>
      </div>

      <p v-if="toast" class="text-sm text-green-700 bg-green-50 border border-green-200 rounded px-3 py-2">
        {{ toast }}
      </p>
    </div>

    <!-- 미리보기 -->
    <div class="p-4 bg-gray-100 rounded border overflow-auto">
      <div
        id="resume-preview"
        class="mx-auto max-w-full min-h-[297mm] bg-white border border-black shadow-sm p-[14mm] relative"
        :class="previewWidthClass"
      >
        <div class="flex">
          <div class="w-[32mm] h-[40mm] border border-black flex items-center justify-center overflow-hidden">
            <img v-if="photoUrl" :src="photoUrl" alt="증명사진" class="object-cover w-full h-full" />
            <span v-else class="text-[10px] text-gray-500">사진</span>
          </div>
          <div class="flex-1 text-center">
            <div class="text-[28px] font-bold tracking-[6px]">이 력 서</div>
          </div>
        </div>

        <table class="w-full mt-4 border-collapse text-[11px]">
          <tbody>
            <tr>
              <td class="w-[20%] border border-black text-center font-semibold">성명</td>
              <td class="border border-black pl-2">{{ resumeData.name || '\u00A0' }}</td>
              <td class="w-[20%] border border-black text-center font-semibold">생년월일</td>
              <td class="border border-black pl-2">{{ resumeData.birthDate || '\u00A0' }}</td>
            </tr>
            <tr>
              <td class="border border-black text-center font-semibold">주소</td>
              <td colspan="3" class="border border-black pl-2">{{ resumeData.address || '\u00A0' }}</td>
            </tr>
            <tr>
              <td class="border border-black text-center font-semibold">연락처</td>
              <td class="border border-black pl-2">{{ resumeData.phone || '\u00A0' }}</td>
              <td class="border border-black text-center font-semibold">이메일</td>
              <td class="border border-black pl-2">{{ resumeData.email || '\u00A0' }}</td>
            </tr>
          </tbody>
        </table>

        <table class="w-full mt-6 border-collapse text-[11px]">
          <thead>
            <tr>
              <th class="border border-black w-[18%] py-1">년 월 일</th>
              <th class="border border-black w-[52%] py-1">학력 및 경력사항</th>
              <th class="border border-black w-[30%] py-1">발령청(비고)</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="(career, idx) in careersWithFillers" :key="idx">
              <td class="border border-black text-center align-top py-[6px]">{{ career.date || '\u00A0' }}</td>
              <td class="border border-black pl-2 align-top">{{ career.content || '\u00A0' }}</td>
              <td class="border border-black pl-2 align-top">{{ career.note || '\u00A0' }}</td>
            </tr>
          </tbody>
        </table>

        <div class="mt-8 text-[11px] space-y-3">
          <p class="text-center">위 기재 사항은 사실과 틀림없음을 확인합니다.</p>
          <div class="flex justify-end pr-4">
            <div class="text-right">
              <div>작성일: {{ resumeData.writtenDate || '\u00A0' }}</div>
              <div class="flex items-center justify-end gap-3 mt-2">
                <span>작성자: {{ resumeData.name || '\u00A0' }}</span>
                <span class="inline-block min-w-[60px] border-b border-black text-center">{{ resumeData.signature || '\u00A0' }}</span>
                <span>(서명)</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { computed, reactive, ref } from 'vue'
import html2canvas from 'html2canvas'
import jsPDF from 'jspdf'
import { generateResumeDocx, type ResumePayload } from '../api'

const emit = defineEmits(['saved'])

interface CareerRow {
  date: string
  content: string
  note: string
}

interface ResumeData {
  name: string
  birthDate: string
  address: string
  phone: string
  email: string
  writtenDate: string
  signature: string
  careers: CareerRow[]
}

const resumeData = reactive<ResumeData>({
  name: '',
  birthDate: '',
  address: '',
  phone: '',
  email: '',
  writtenDate: '',
  signature: '',
  careers: [createEmptyCareer()],
})

const photoUrl = ref<string>('')
const minCareerRows = 18
const loadingDocx = ref(false)
const toast = ref('')

// 화면 비율에 따라 미리보기 너비를 줄여 사이드바 영역이 잘리지 않도록 함
const previewWidthClass = computed(() => [
  'w-[180mm]',
  'md:w-[190mm]',
  'lg:w-[200mm]',
  'xl:w-[210mm]',
].join(' '))

const docxOptions = reactive({
  saveToDocuments: false,
  documentTitle: '이력서',
  status: '완료',
})

const careersWithFillers = computed(() => {
  const fillers = Math.max(0, minCareerRows - resumeData.careers.length)
  return [...resumeData.careers, ...Array.from({ length: fillers }, createEmptyCareer)]
})

function createEmptyCareer(): CareerRow {
  return { date: '', content: '', note: '' }
}

function addCareer() {
  resumeData.careers.push(createEmptyCareer())
}

function removeCareer(idx: number) {
  if (resumeData.careers.length === 1) return
  resumeData.careers.splice(idx, 1)
}

function resetForm() {
  resumeData.name = ''
  resumeData.birthDate = ''
  resumeData.address = ''
  resumeData.phone = ''
  resumeData.email = ''
  resumeData.writtenDate = ''
  resumeData.signature = ''
  resumeData.careers = [createEmptyCareer()]
  photoUrl.value = ''
  docxOptions.saveToDocuments = false
  docxOptions.documentTitle = '이력서'
  docxOptions.status = '완료'
}

function onPhotoChange(event: Event) {
  const target = event.target as HTMLInputElement
  const file = target.files?.[0]
  if (!file) return
  const reader = new FileReader()
  reader.onload = (e) => {
    photoUrl.value = e.target?.result as string
  }
  reader.readAsDataURL(file)
}

async function downloadPDF() {
  const preview = document.getElementById('resume-preview')
  if (!preview) return
  const canvas = await html2canvas(preview, { scale: 2, useCORS: true })
  const imgData = canvas.toDataURL('image/png')
  const pdf = new jsPDF({ unit: 'mm', format: 'a4' })
  const pageWidth = 210
  const imgProps = pdf.getImageProperties(imgData)
  const imgWidth = pageWidth
  const imgHeight = (imgProps.height * imgWidth) / imgProps.width
  pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight)
  pdf.save(`${resumeData.name || '이력서'}.pdf`)
}

function mapCareersToExperiences(): ResumePayload['experiences'] {
  return resumeData.careers
    .map((career) => ({
      company: career.note || undefined,
      role: career.content || undefined,
      period: career.date || undefined,
      achievements: [],
    }))
    .filter((exp) => Object.values(exp).some((v) => (Array.isArray(v) ? v.length : v)))
}

async function generateDocx() {
  if (!resumeData.name) {
    toast.value = '이름을 입력해 주세요.'
    setTimeout(() => (toast.value = ''), 2500)
    return
  }

  const payload: ResumePayload = {
    name: resumeData.name,
    phone: resumeData.phone || undefined,
    email: resumeData.email || undefined,
    address: resumeData.address || undefined,
    experiences: mapCareersToExperiences(),
    save_to_documents: docxOptions.saveToDocuments,
    document_title: docxOptions.documentTitle || '이력서',
    status: docxOptions.status || '완료',
  }

  loadingDocx.value = true
  toast.value = ''
  try {
    const result = await generateResumeDocx(payload)
    downloadBlob(result.blob, result.filename)
    if (result.saved) {
      emit('saved')
      toast.value = '서류함에 저장되고 DOCX가 다운로드되었습니다.'
    } else {
      toast.value = 'DOCX가 다운로드되었습니다.'
    }
  } catch (e) {
    console.error('DOCX 생성 실패', e)
    toast.value = 'DOCX 생성에 실패했습니다. 로그인 상태를 확인하세요.'
  } finally {
    loadingDocx.value = false
    setTimeout(() => (toast.value = ''), 4000)
  }
}

function downloadBlob(blob: Blob, filename: string) {
  const url = window.URL.createObjectURL(blob)
  const a = document.createElement('a')
  a.href = url
  a.download = filename
  document.body.appendChild(a)
  a.click()
  a.remove()
  window.URL.revokeObjectURL(url)
}
</script>
