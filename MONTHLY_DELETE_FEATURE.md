# 월별 근로기록 삭제 기능

## 개요
특정 월의 모든 근로기록과 월별 스케줄을 한번에 삭제할 수 있는 기능입니다.

## 기능 설명

### 1. UI 위치
- 캘린더 상단의 "월별 스케줄 변경" 버튼 옆에 "🗑️ 월별 기록 삭제" 버튼이 추가되었습니다.

### 2. 동작 방식
1. 사용자가 "월별 기록 삭제" 버튼을 클릭
2. 확인 다이얼로그가 표시됨 (삭제 대상 상세 표시)
3. 확인 시 해당 월의 모든 데이터가 삭제됨:
   - ✅ **실제 근로기록 (WorkRecord)**: 날짜별로 입력한 실제 근무 시간
   - ✅ **월별 스케줄 (MonthlySchedule)**: "월별 스케줄 변경"으로 설정한 해당 월의 근무 스케줄
4. 삭제 후 관련 통계가 자동으로 실시간 업데이트됨

### 3. 제약사항
- **미래 월 차단**: 미래 월의 기록은 삭제할 수 없습니다.
- **복구 불가**: 삭제된 기록은 복구할 수 없으므로 신중하게 사용해야 합니다.

### 4. 연동 데이터
삭제 시 자동으로 **실시간** 업데이트되는 항목:
- ✅ 월별 근로시간 통계
- ✅ 예상 급여 정보
- ✅ 주휴수당 계산
- ✅ **알바 업적 (총 근로시간 등) - 새로고침 불필요**
- ✅ 누적 통계
- ✅ 캘린더 표시

## 삭제 대상 상세

### 1. 실제 근로기록 (WorkRecord)
- 캘린더에서 날짜를 클릭하여 입력한 실제 근무 시간
- 주황색으로 표시된 날짜의 데이터

### 2. 월별 스케줄 (MonthlySchedule)
- "월별 스케줄 변경" 버튼으로 설정한 해당 월의 특별 근무 스케줄
- 주간 스케줄과 다르게 특정 월에만 적용되는 스케줄
- 이전에는 삭제되지 않았으나, **이제 함께 삭제됨**

### 3. 주간 스케줄 (WorkSchedule)
- ❌ **삭제되지 않음**
- "근로정보 수정" → "주간 근무 스케줄"에서 설정한 기본 스케줄
- 모든 월에 공통으로 적용되는 기본 패턴이므로 보존됨

## API 엔드포인트

### DELETE /api/labor/employees/{id}/monthly-work-records/

**요청 파라미터:**
```
month: YYYY-MM (예: 2025-11)
```

**응답:**
```json
{
  "message": "2025년 11월의 근로기록 8건, 월별 스케줄 8건이 삭제되었습니다.",
  "deleted_count": 16,
  "work_records_deleted": 8,
  "monthly_schedules_deleted": 8,
  "stats": {
    "month": "2025-11",
    "total_hours": 0,
    "total_pay": 0,
    ...
  },
  "dates": [...],
  "cumulative_stats": {
    "total_hours": 234.5,
    "total_earnings": 2814000,
    "total_work_days": 47,
    "start_date": "2024-09-01"
  }
}
```

**에러 응답:**
- `400 Bad Request`: month 파라미터 누락 또는 형식 오류
- `404 Not Found`: 해당 Job을 찾을 수 없음

## 사용 예시

### 시나리오 1: 실제 근로기록만 있는 경우
1. 캘린더에서 2025년 11월로 이동
2. "월별 기록 삭제" 버튼 클릭
3. 확인: "근로기록 16건이 삭제되었습니다"
4. 결과: 캘린더의 주황색 날짜가 사라지고 통계가 0으로 변경

### 시나리오 2: 월별 스케줄도 설정한 경우
1. 이전에 "월별 스케줄 변경"으로 특정 월의 근무 시간을 변경함
2. "월별 기록 삭제" 버튼 클릭
3. 확인: "근로기록 8건, 월별 스케줄 8건이 삭제되었습니다"
4. 결과: 
   - 실제 근로기록 삭제
   - 월별 스케줄 설정 삭제 (기본 주간 스케줄로 복귀)
   - 알바 업적이 **즉시** 업데이트됨

### 시나리오 3: 빈 월 삭제
1. 근로기록이 없는 월에서 삭제 시도
2. 확인: "2025년 12월에는 삭제할 데이터가 없습니다"

## 주의사항

⚠️ **중요**: 이 기능은 되돌릴 수 없습니다. 삭제 전 반드시 확인하세요.

### 권장 사항
- 월별 데이터를 수정하기 전에 데이터를 백업하거나 스크린샷을 저장하세요.
- 실수로 삭제한 경우:
  - 실제 근로기록: 각 날짜별로 다시 입력
  - 월별 스케줄: "월별 스케줄 변경"으로 다시 설정

### 삭제 확인 다이얼로그
```
2025년 11월의 모든 근로 기록을 삭제하시겠습니까?

• 실제 근로기록 (WorkRecord)
• 월별 스케줄 설정 (MonthlySchedule)

삭제된 기록은 복구할 수 없으며, 통계 및 주휴수당, 알바 업적 등 
모든 연동된 데이터가 함께 업데이트됩니다.
```

## 기술 세부사항

### 백엔드 구현
- **위치**: `labor/views.py`의 `EmployeeViewSet.delete_monthly_work_records()`
- **삭제 대상**:
  1. `WorkRecord`: 해당 월의 모든 실제 근로기록
  2. `MonthlySchedule`: 해당 월의 모든 월별 스케줄 설정
- **트랜잭션**: Django ORM의 delete()를 사용하여 원자적으로 처리
- **통계 재계산**: 
  - 월별 통계: `compute_monthly_schedule_stats()`
  - 누적 통계: `get_cumulative_stats_data()` (신규 추가)

### 누적 통계 계산 로직 (v3 - 중요 변경)
**문제점**: 기존에는 주간 스케줄 기반 "예상 근로시간"까지 포함하여 집계했기 때문에, 실제 근로기록을 삭제해도 스케줄 시간이 남아있어 통계가 변하지 않았음.

**해결**: 이제 **실제 근로기록(WorkRecord)만 집계**합니다.

```python
def get_cumulative_stats_data(self, job):
    """누적 통계 계산 - 실제 근로기록만 집계"""
    # 실제 근로기록만 조회
    work_records = WorkRecord.objects.filter(
        employee=job,
        work_date__gte=start_date,
        work_date__lte=today
    )
    
    # 실제 근로기록만 집계 (스케줄 제외)
    for record in work_records:
        hours = record.get_total_hours()
        if hours > 0:
            total_hours += hours
            total_work_days += 1
```

**변경 효과**:
- ✅ 실제 일한 시간만 집계 (정확한 업적 계산)
- ✅ 삭제 시 즉시 반영됨
- ✅ 스케줄만 설정하고 실제 일하지 않으면 0시간으로 표시

### 프론트엔드 구현
- **위치**: `frontend/src/components/WorkCalendar.vue`
- **상태 관리**: `isDeleting` ref를 사용하여 중복 클릭 방지
- **UX**: 
  - 상세한 확인 다이얼로그 표시
  - 삭제된 항목별 개수 표시
  - 성공/실패 메시지 제공
- **데이터 동기화**: 
  - `statsUpdated` 이벤트 발생으로 월별 통계 업데이트
  - `labor-updated` 전역 이벤트 발생으로 **알바 업적 자동 업데이트**
  - 새로고침 없이 모든 관련 컴포넌트 실시간 업데이트

### 개선 사항 (v3 - 최종)
1. ✅ **월별 스케줄도 삭제**: WorkRecord + MonthlySchedule 모두 삭제
2. ✅ **누적 통계 실시간 업데이트**: 삭제 후 알바 업적이 자동으로 갱신됨
3. ✅ **실제 근로기록만 집계**: 스케줄 기반 예상 시간 제외로 정확한 통계
4. ✅ **즉시 반영**: 삭제 시 실시간으로 모든 통계 업데이트
5. ✅ **상세한 피드백**: 삭제된 항목의 개수를 구분하여 표시
6. ✅ **전역 이벤트 발생**: 다른 컴포넌트들도 자동으로 최신 데이터 반영

## 버전 정보
- 추가 날짜: 2025년 12월 17일
- 업데이트: 
  - v2 (2025-12-17): 월별 스케줄 삭제 및 실시간 업적 업데이트 추가
  - **v3 (2025-12-17): 누적 통계를 실제 근로기록만 집계하도록 수정 (스케줄 제외)**
- 관련 파일:
  - `labor/views.py` (백엔드 API)
  - `frontend/src/components/WorkCalendar.vue` (프론트엔드 UI)
  - `frontend/src/components/UserAchievementCard.vue` (자동 업데이트)
