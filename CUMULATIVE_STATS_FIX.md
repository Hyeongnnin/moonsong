# 알바 업적 계산 로직 개선

## 문제점

기존 cumulative_stats API는 **실제 근로기록(WorkRecord)만** 집계했습니다.
- 캘린더에 수동으로 입력된 근로기록만 계산
- 주간 근무 스케줄 기반 예상 근로는 반영 안 됨
- 월별 스케줄 변경도 반영 안 됨

**결과**: 사용자가 과거 날짜를 일일이 캘린더에서 수정하지 않으면 업적이 부정확하게 표시됨

## 개선 내용

### 새로운 계산 로직

근로 시작일부터 오늘까지 **모든 날짜를 순회**하며, 각 날짜마다 다음 우선순위로 근로시간 계산:

```
1순위: 실제 근로기록 (WorkRecord)
   ↓ 없으면
2순위: 월별 스케줄 (MonthlySchedule)
   ↓ 없으면  
3순위: 기본 주간 스케줄 (WorkSchedule)
   ↓ 없으면
0시간 (근무 없음)
```

### 상세 동작 방식

#### 1. 실제 근로기록 우선
```python
if current_date in work_records_map:
    record = work_records_map[current_date]
    hours = record.get_total_hours()  # 실제 출퇴근 시간 - 휴게시간
    if hours > 0:
        total_hours += hours
        total_work_days += 1
```

#### 2. 월별 스케줄 적용
```python
elif (year, month, weekday) in monthly_schedule_map:
    schedule = monthly_schedule_map[(year, month, weekday)]
    hours = calculate_hours(schedule.start_time, schedule.end_time)
    if hours > 0:
        total_hours += hours
        total_work_days += 1
```

#### 3. 기본 주간 스케줄 적용
```python
elif weekday in default_schedule_map:
    schedule = default_schedule_map[weekday]
    hours = calculate_hours(schedule.start_time, schedule.end_time)
    if hours > 0:
        total_hours += hours
        total_work_days += 1
```

## 사용자 시나리오 예시

### Before (기존 로직)
```
근로 시작일: 2025-01-01
주간 스케줄: 월/수/금 09:00-18:00 (하루 8시간, 주 24시간)
실제 수동 입력한 기록: 2일치만

계산 결과:
- 총 근로시간: 16시간 (2일 × 8시간)
- 총 근무 일수: 2일
❌ 45일간 일했는데 2일치만 인정됨
```

### After (개선된 로직)
```
근로 시작일: 2025-01-01
주간 스케줄: 월/수/금 09:00-18:00
기간: 2025-01-01 ~ 2025-02-14 (45일)

자동 계산:
- 월요일 7회 × 8시간 = 56시간
- 수요일 7회 × 8시간 = 56시간  
- 금요일 6회 × 8시간 = 48시간

계산 결과:
- 총 근로시간: 160시간 (20일 × 8시간)
- 총 근무 일수: 20일
✅ 실제 근무 예상치와 일치
```

### 월별 스케줄 변경 반영
```
2025-01월: 월/수/금 근무 (주 3일)
2025-02월: 월~금 근무로 변경 (주 5일)
  → "이번 달 스케줄 변경" 기능으로 2월만 변경

계산 결과:
- 1월: 13일 근무 (1월 월/수/금만)
- 2월: 10일 근무 (2월 1~14일 중 월~금)
- 총 23일 정확히 반영
✅ 월별 변경사항 자동 반영
```

## 기술적 세부사항

### API 엔드포인트
- **GET** `/api/labor/employees/<id>/cumulative-stats/`

### 응답 형식
```json
{
  "total_hours": 160.0,
  "total_earnings": 1920000.0,
  "total_work_days": 20,
  "start_date": "2025-01-01"
}
```

### 성능 최적화
- 월별 스케줄을 미리 딕셔너리로 매핑: `O(M)` (M = 월별 스케줄 개수)
- 실제 기록을 날짜로 매핑: `O(R)` (R = 실제 기록 개수)
- 날짜 순회: `O(D)` (D = 근로 일수)
- **총 시간복잡도**: `O(D + R + M)` - 선형 시간

### 데이터 우선순위 이유
1. **실제 기록 최우선**: 사용자가 수정한 정보가 가장 정확
2. **월별 스케줄 2순위**: 특정 월의 근무 패턴 변경 반영
3. **주간 스케줄 3순위**: 기본 근무 패턴 적용

## 사용자 이점

✅ **과거 수정 불필요**: 캘린더를 일일이 수정하지 않아도 정확한 통계
✅ **월별 변경 자동 반영**: 특정 월 스케줄 변경이 자동으로 업적에 반영
✅ **실제 기록 우선**: 출퇴근 시간 수정하면 즉시 반영
✅ **논리적 일관성**: 근무 예정 = 근무로 간주 (특별한 기록이 없는 한)

## 테스트 시나리오

### 1. 기본 시나리오
1. 근로정보 수정에서 시작일과 주간 스케줄 설정
2. 근로관리 페이지에서 알바 업적 확인
3. ✅ 시작일부터 오늘까지 스케줄 기반 통계 표시됨

### 2. 월별 스케줄 변경
1. 3개월 전부터 알바 시작
2. 이번 달 스케줄만 변경 (근무일 증가)
3. ✅ 과거는 기본 스케줄, 이번 달은 변경된 스케줄로 계산됨

### 3. 실제 기록 우선
1. 특정 날짜에 스케줄 있음 (09:00-18:00, 8시간)
2. 캘린더에서 해당 날짜 클릭 → 실제는 5시간만 근무로 수정
3. ✅ 업적에 8시간이 아닌 5시간으로 반영됨

### 4. 결근 처리
1. 스케줄이 있는 날짜에 캘린더에서 0시간 기록 생성
2. ✅ 해당 날짜는 업적 계산에서 제외됨

## 주의사항

- 근로 시작일(start_date)이 필수입니다
- 시작일이 없으면 0으로 반환됩니다
- 미래 날짜는 계산에 포함되지 않습니다 (오늘까지만)
- 0시간 근로기록은 "결근"으로 간주되어 제외됩니다
